#!/usr/bin/env ruby -wKU

begin 
  require "bam_helpers"
  require "bam"
rescue LoadError
  require "rubygems"
  require "bam_helpers"
  require "bam"
end

include BamHelpers

pwd = Dir.pwd
bampath = File.join(pwd, "deploy.bam")
dry_run = false

case ARGV[0]
when "--dry"
  dry_run = true

end

if File.exists?(bampath)
  @pre_deploy_tasks, @post_deploy_tasks, @always_include = nil
  deployfile = File.read(File.join(pwd,"deploy.bam"))
  eval deployfile
  ready_to = Bam::Deployment.new @server, @to, pwd, dry_run
  puts wrap_borders("Executing DRY RUN") if dry_run
  unless @pre_deploy_tasks.nil?
    puts "PRE-DEPLOYMENT TASKS: \n\n"
    ready_to.deploy_tasks(@pre_deploy_tasks) 
  end
  ready_to.deploy(@always_include)
  unless @post_deploy_tasks.nil?
    puts "POST-DEPLOYMENT TASKS: \n\n"
    ready_to.deploy_tasks(@post_deploy_tasks) 
  end
else
  puts "No deploy.bam file found, run bamify to generate one."
end